name: Claude Code PR Review

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: false

jobs:
  claude-review:
    # Run on PR events, or on @claude mentions in comments
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          timeout_minutes: 10
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
            
            Review this PR for nansen-cli (Node.js CLI for Nansen API). Be thorough but fair.
            
            **Hard Rules (auto request changes):**
            - ES modules only (import/export, NEVER require)
            - All CLI output MUST be structured JSON
            - Zero external dependencies (Node.js built-ins + vitest only)
            
            **Severity ratings:**
            ðŸ”´ **Blocking**: Security (API keys in code, unsanitized shell input, eval), correctness bugs, breaking changes, missing tests
            ðŸŸ¡ **Should Fix**: Error handling gaps, unhandled edge cases, missing README/changeset
            ðŸŸ¢ **Nitpicks**: Style, naming, docs
            
            **Anti-patterns:** Silent catch blocks, console.log (use JSON), unhandled promises, loose equality (==)
            
            **Instructions:**
            1. Review the PR diff using `gh pr diff ${{ github.event.pull_request.number || github.event.issue.number }}`
            2. **Post findings as INLINE comments** on specific lines using the inline comment tool - one comment per issue, placed directly on the relevant line
            3. Post a brief top-level summary (2-3 sentences max) with: verdict + effort level (1-4)
            4. **Submit your verdict:**
               - If ANY ðŸ”´ blocking issues: `gh pr review ${{ github.event.pull_request.number || github.event.issue.number }} --request-changes -b "See inline comments"`
               - If NO ðŸ”´ issues: `gh pr review ${{ github.event.pull_request.number || github.event.issue.number }} --approve -b "LGTM"`
            
            DO NOT list line-by-line findings in the summary comment. Use inline comments instead.
          
          show_full_output: true
          claude_args: |
            --allowedTools "Bash(gh pr *),Bash(gh api *),mcp__github_inline_comment__create_inline_comment"
